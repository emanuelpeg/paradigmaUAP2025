import { Biblioteca } from "./Biblioteca";
import { Socio } from "./Socio";
import { Libro } from "./Libro";

// Extensión de Biblioteca para sistema de reservas
class BibliotecaConReservas extends Biblioteca {
    private reservas: Map<string, number[]> = new Map(); // ISBN -> cola de IDs de socios

    retirarLibro(socioId: number, libroISBN: string): void {
        const socio = this.buscarSocio(socioId);
        const libro = this.buscarLibro(libroISBN);
        if (!socio || !libro) {
            throw new Error("No se encontró el socio o el libro");
        }
        // Verifica si el libro está prestado
        if (libro.estaPrestado()) {
            this.reservarLibro(socioId, libroISBN);
            throw new Error("Libro no disponible, se ha reservado");
        }
        socio.retirar(libro, this.DURACION);
    }

    devolverLibro(socioId: number, libroISBN: string) {
        const socio = this.buscarSocio(socioId);
        const libro = this.buscarLibro(libroISBN);
        if (!socio || !libro) {
            throw new Error("No se encontró el socio o el libro");
        }
        socio.devolver(libro);
        this.notificarReserva(libroISBN);
    }

    reservarLibro(socioId: number, libroISBN: string) {
        if (!this.reservas.has(libroISBN)) {
            this.reservas.set(libroISBN, []);
        }
        const cola = this.reservas.get(libroISBN)!;
        if (!cola.includes(socioId)) {
            cola.push(socioId);
        }
    }

    notificarReserva(libroISBN: string) {
        const cola = this.reservas.get(libroISBN);
        if (cola && cola.length > 0) {
            const siguienteSocioId = cola.shift();
            if (siguienteSocioId !== undefined) {
                const socio = this.buscarSocio(siguienteSocioId);
                if (socio) {
                    console.log(`Socio ${socio.nombre} ${socio.apellido} ha sido notificado: el libro ${libroISBN} está disponible para retirar.`);
                }
            }
            this.reservas.set(libroISBN, cola);
        }
    }
}
